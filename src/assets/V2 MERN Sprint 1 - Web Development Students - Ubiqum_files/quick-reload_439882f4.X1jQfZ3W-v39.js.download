(window.webpackJsonp=window.webpackJsonp||[]).push([["quick-reload~439882f4"],{UnvT:function(e,t,i){"use strict";i.r(t);var s=i("ERkP"),o=i.n(s),n=i("lZoD"),a=i("qhEF"),l=i("/FQd"),r=i("pkwY"),d=i("zjfJ"),c=i("L21V");class m extends s.Component{constructor(...e){super(...e),Object(d.a)(this,"startPoller",()=>{this.stopPoller=this.props.poller(this.props.intl,this.props.timer,this.props.contentId,this.props.currentAccountId,this.props.lastPollTime,this.makeShowFlag,this.hideFlags)}),Object(d.a)(this,"stopPoller",()=>{}),Object(d.a)(this,"actions",[{content:o.a.createElement("div",{"data-test-id":"quick-reload-reload-button"},"Reload"),onClick:()=>window.location.reload()}]),Object(d.a)(this,"showingFlagIdsForType",{edit:void 0,comment:void 0}),Object(d.a)(this,"makeShowFlag",e=>async t=>{const i=this.showingFlagIdsForType[e],s=await this.props.flagsStateContainer.showInfoFlag(Object(r.a)({},t,{actions:this.actions,onClose:()=>{delete this.showingFlagIdsForType[e],t.onClose()}}));this.showingFlagIdsForType[e]=s.id,void 0!==i&&await this.props.flagsStateContainer.hideFlag(i)}),Object(d.a)(this,"hideFlags",()=>{["edit","comment"].forEach(async e=>{const t=this.showingFlagIdsForType[e];void 0!==t&&(await this.props.flagsStateContainer.hideFlag(t),delete this.showingFlagIdsForType[t])})})}componentDidMount(){this.startPoller()}componentDidUpdate(e){this.props.contentId!==e.contentId&&(this.stopPoller(),this.startPoller())}componentWillUnmount(){this.stopPoller()}render(){return null}}m.displayName="QuickReloadFlagsI18nProviderComponent";const h=Object(c.h)(m);var u=i("8TdO"),p=i("KD1n"),b=i("H5qd");function v(){const e=Object(p.a)(["\n  query QuickReloadQuery($contentId: ID!, $since: ExperimentalLong!)\n    @experimental {\n    experimentalQuickReload(contentId: $contentId, since: $since) {\n      time\n      editorForPage {\n        displayName\n        accountId\n      }\n      comments {\n        comment {\n          id\n          author {\n            displayName\n            accountId\n          }\n        }\n      }\n    }\n  }\n"]);return v=function(){return e},e}const g=i.n(b)()(v()),w=Object(c.g)({newVersion:{id:"quick-reload.new-version-published",description:"Flag title to inform user that a new page version is avilable on reload",defaultMessage:"New version published"},newComment:{id:"quick-reload.new-comment",description:"Flag title to inform user that a new page comment is avilable on reload",defaultMessage:"New comment"},newComments:{id:"quick-reload.new-comments",description:"Flag title to inform user that multiple new page comments are avilable on reload",defaultMessage:"{numComments} new comments"},somebodyCommented:{id:"quick-reload.somebody-commented",description:"Flag description to inform who has added a comment",defaultMessage:"{somebody} commented on this page"},twoPeopleCommented:{id:"quick-reload.two-people-commented",description:"Flag description to inform that two people have added comments",defaultMessage:"{somebody} and {somebodyElse} commented on this page"},atLeastThreePeopleCommented:{id:"quick-reload.at-least-three-people-commented",description:"Flag description to inform that multiple people have added comments",defaultMessage:"{somebody} and {numOthers} others commented on this page"},somebodyPublished:{id:"quick-reload.somebody-published",description:"Flag description to inform who has re-published this page",defaultMessage:"{somebody} published a new version of this page"},twoPeoplePublished:{id:"quick-reload.two-people-published",description:"Flag description to inform that two people have re-published this page",defaultMessage:"{somebody} and {somebodyElse} published a new version of this page"},atLeastThreePeoplePublished:{id:"quick-reload.at-least-three-people-published",description:"Flag description to inform that multiple people have re-published this page",defaultMessage:"{somebody} and {numOthers} others published a new version of this page"}});class y{constructor(e,t,i){this.intl=e,this.currentAccountId=t,this.showFlag=i,Object(d.a)(this,"numEvents",0),Object(d.a)(this,"uniqueNames",[]),Object(d.a)(this,"resetEvents",()=>{this.numEvents=0,this.uniqueNames=[]})}addEvents(e){let t=!1;if(e.forEach(e=>{e.accountId&&this.currentAccountId&&e.accountId===this.currentAccountId||(this.numEvents++,this.uniqueNames=[e.displayName,...this.uniqueNames.filter(t=>t!==e.displayName)],t=!0)}),t){const e=this.createMessage();this.showFlag(e)}}}class f extends y{createMessage(){const e={title:this.intl.formatMessage(w.newVersion),onClose:this.resetEvents};switch(this.uniqueNames.length){case 1:return Object(r.a)({},e,{description:this.intl.formatMessage(w.somebodyPublished,{somebody:this.uniqueNames[0]})});case 2:return Object(r.a)({},e,{description:this.intl.formatMessage(w.twoPeoplePublished,{somebody:this.uniqueNames[0],somebodyElse:this.uniqueNames[1]})});default:return Object(r.a)({},e,{description:this.intl.formatMessage(w.atLeastThreePeoplePublished,{somebody:this.uniqueNames[0],numOthers:this.uniqueNames.length-1})})}}}class F extends y{createMessage(){const e={onClose:this.resetEvents,title:1===this.numEvents?this.intl.formatMessage(w.newComment):this.intl.formatMessage(w.newComments,{numComments:this.numEvents})};switch(this.uniqueNames.length){case 1:return Object(r.a)({},e,{description:this.intl.formatMessage(w.somebodyCommented,{somebody:this.uniqueNames[0]})});case 2:return Object(r.a)({},e,{description:this.intl.formatMessage(w.twoPeopleCommented,{somebody:this.uniqueNames[0],somebodyElse:this.uniqueNames[1]})});default:return Object(r.a)({},e,{description:this.intl.formatMessage(w.atLeastThreePeopleCommented,{somebody:this.uniqueNames[0],numOthers:this.uniqueNames.length-1})})}}}async function k(e,t,i,s){return async function(e,t,i,s,o){var n,a,l;let r;try{r=await e({query:g,variables:{contentId:i,since:t},fetchPolicy:"no-cache",errorPolicy:"all",context:{fetchOptions:{ignoreNoNetworkError:!0},single:!0}})}catch(e){return}if(r.errors&&r.errors.length)return;if(o.stopped)return;if(s!==o.querySeq)return;const d=((null!=(l=r)&&null!=(l=l.data)&&null!=(l=l.experimentalQuickReload)?l.comments:l)||[]).map(e=>{var t,i;return{displayName:null!=(i=e)&&null!=(i=i.comment)&&null!=(i=i.author)?i.displayName:i,accountId:null!=(t=e)&&null!=(t=t.comment)&&null!=(t=t.author)?t.accountId:t}});d.length&&o.commentsStream.addEvents(d);const c=null!=(a=r)&&null!=(a=a.data)&&null!=(a=a.experimentalQuickReload)?a.editorForPage:a;if(c){var m,h;const e=(null!=(h=c)?h.displayName:h)||"",t=(null!=(m=c)?m.accountId:m)||null;o.editsStream.addEvents([{displayName:e,accountId:t}])}return null!=(n=r)&&null!=(n=n.data)&&null!=(n=n.experimentalQuickReload)?n.time:n}(Object(u.getApolloClient)().query,e,t,i,s)}function C(e,t,i,s,o,n,a){const l={querySeq:0,stopped:!1,editsStream:new f(e,s,n("edit")),commentsStream:new F(e,s,n("comment"))},r=new t(async()=>{const e=await k(o,i,++l.querySeq,l);e&&(o=e)});return r.start(),()=>{l.stopped=!0,r.stop(),a()}}var q=i("Bcqe"),A=i.n(q);const O={min:3e4,max:6e4,inactivity:12e4},T={min:4e3,max:4e3,inactivity:4e3};class E{isDocumentHidden(){return"boolean"==typeof window.__documentHiddenOverrideForUnitTest?window.__documentHiddenOverrideForUnitTest:document.hidden}calculateNextDue(){const e=Date.now()-this.lastActivityAt>=this.options.inactivity?this.options.max:this.options.min;return this.lastCallbackAt+e}setTimerToFireAt(e){void 0!==this.timer&&clearTimeout(this.timer);const t=Date.now(),i=Math.max(0,e-t);this.timer=setTimeout(this.timerDidFire,i),this.nextCallbackAt=t+i}bringTimerForwardTo(e){this.nextCallbackAt>e&&this.setTimerToFireAt(e)}executeCallback(){setTimeout(this.callback,0),this.lastCallbackAt=Date.now()}setTimerFromCold(){this.setTimerToFireAt(this.calculateNextDue())}constructor(e,t={}){if(this.callback=e,Object(d.a)(this,"options",void 0),Object(d.a)(this,"timer",void 0),Object(d.a)(this,"lastActivityAt",void 0),Object(d.a)(this,"lastCallbackAt",void 0),Object(d.a)(this,"nextCallbackAt",void 0),Object(d.a)(this,"timerDidFire",()=>{this.timer=void 0,this.executeCallback(),this.setTimerFromCold()}),Object(d.a)(this,"didReceiveActivity",A()(()=>{this.lastActivityAt=Date.now(),this.bringTimerForwardTo(this.calculateNextDue())},500)),Object(d.a)(this,"visibilityDidChange",()=>{this.isDocumentHidden()?(void 0!==this.timer&&clearTimeout(this.timer),this.timer=void 0,this.nextCallbackAt=1/0):(this.lastActivityAt=Date.now(),this.setTimerFromCold())}),this.options=Object(r.a)({},O,t),window.__fastQuickReloadTimerForIntegrationTest){this.options=Object(r.a)({},this.options,T);const e=document.createElement("div");e.setAttribute("data-test-id","quick-reload-test-marker"),document.body.appendChild(e)}this.lastActivityAt=0,this.lastCallbackAt=0,this.nextCallbackAt=0}start(){window.addEventListener("focus",this.didReceiveActivity),document.addEventListener("visibilitychange",this.visibilityDidChange),document.addEventListener("click",this.didReceiveActivity),document.addEventListener("scroll",this.didReceiveActivity);const e=Date.now();this.lastCallbackAt=e,this.lastActivityAt=e,this.nextCallbackAt=1/0,this.setTimerFromCold()}stop(){window.removeEventListener("focus",this.didReceiveActivity),document.removeEventListener("visibilitychange",this.visibilityDidChange),document.removeEventListener("click",this.didReceiveActivity),document.removeEventListener("scroll",this.didReceiveActivity),clearTimeout(this.timer),this.timer=void 0}}i.d(t,"QuickReload",(function(){return I}));class I extends s.Component{render(){return o.a.createElement(n.c,{to:[a.a]},e=>o.a.createElement(l.a,null,({userId:t})=>o.a.createElement(h,{flagsStateContainer:e,poller:C,contentId:this.props.contentId,currentAccountId:t,lastPollTime:this.props.lastPollTime,timer:this.props.timerOverride||E})))}}I.displayName="QuickReload"}}]);
//# sourceMappingURL=quick-reload~439882f4.X1jQfZ3W-v39.js.map