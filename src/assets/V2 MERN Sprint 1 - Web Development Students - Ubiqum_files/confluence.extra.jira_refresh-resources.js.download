WRMCB=function(e){var c=console;if(c&&c.log&&c.error){c.log('Error running batched script.');c.error(e);}}
;
try {
/* module-key = 'confluence.extra.jira:refresh-resources', location = '/jira/jira-issues-view-mode/refresh-table.js' */
define("confluence/jim/jira/jira-issues-view-mode/refresh-table",["jquery","ajs","confluence/jim/util/connect-helper"],function(d,b,a){var e={REFRESH_STATE_STARTED:1,REFRESH_STATE_DONE:2,REFRESH_STATE_FAILED:3,refreshs:[],sortables:[],init:function(){c.getAll().each(function(){e.registerRefresh(this.getRefresh())});d.each(this.refreshs,function(g,h){var j=c.get(h.id);j.getRefreshButton().bind("click",h,e.handleRefreshClick);j.getRefreshLink().bind("click",h,e.handleRefreshClick);if(j.getContentModule().is("[data-client-id]")){e.processRefreshWaiting(h)}});f.getAll().each(function(){e.registerSort(this.getSortable())});d.each(this.sortables,function(h,g){var j=f.get(g.id);j.getHeadersTable().bind("click",g,e.onHeaderClick)})},onHeaderClick:function(l){var n=l.data.id;var j="ASC";if(d(this).hasClass("tablesorter-headerAsc")){j="DESC"}var h=d(this).find(".jim-table-header-content").text();var p=d(b.format("#refresh-module-{0} .refresh-wiki",n));var k=p.data("wikimarkup");var i=p.data("pageid");var o=d("#refresh-"+n);var m=new e.Refresh(n,k,i,o.html());var q=c.get(n);var g=false;q.updateRefreshVisibility(e.REFRESH_STATE_STARTED);e.processRefresh(m,g,h,j)},updateRefreshedElement:function(k,j){var i=k.attr("id").replace("refresh-module-","");var h=d(j);var g=h.attr("id")&&h.attr("id").replace("refresh-module-","")||undefined;d.each(this.refreshs,function(l,m){if(m.id===i){if(g||h.hasClass("jim-error-message")){c.get(m.id).getContentModule().replaceWith(j);new e.CallbackSupport(m).callback(g)}else{new e.CallbackSupport(m).errorHandler(j)}}})},replaceRefresh:function(i,g){var h=c.get(i);h.updateRefreshVisibility(e.REFRESH_STATE_DONE,g);d.each(this.refreshs,function(m,n){if(n.id===i){e.refreshs.splice(m,1);var o=c.get(g);var k=o.getRefresh();e.registerRefresh(k);e.sortables.splice(m,1);var j=f.get(g);var l=j.getSortable();e.registerSort(l);o.getRefreshButton().bind("click",k,e.handleRefreshClick);o.getRefreshLink().bind("click",k,e.handleRefreshClick);j.getHeadersTable().bind("click",l,e.onHeaderClick)}})},registerRefresh:function(g){if(!(g instanceof e.Refresh)){throw "Refresh object must be an instance of RefreshMacro.Refresh"}e.refreshs.push(g)},registerSort:function(g){if(!(g instanceof e.Sortable)){throw "Refresh object must be an instance of RefreshMacro.Refresh"}e.sortables.push(g)},processRefreshWithData:function(g,h){this.processRefreshWaiting(g,h);e.processRefresh(g,h)},processRefreshWaiting:function(g){var h=c.get(g.id);h.getMacroPanel().html(g.loadingMsg);h.updateRefreshVisibility(e.REFRESH_STATE_STARTED,g.id)},handleRefreshClick:function(g){e.processRefreshWithData(g.data,true)},processRefresh:function(j,k,i,h){var g={type:"POST",dataType:"json",contentType:"application/json",url:"/rest/jiraanywhere/1.0/jira/renderTable",data:b.$.toJSON({wikiMarkup:encodeURIComponent(j.wiki),clearCache:k,columnName:i,order:h}),success:function(l,o){var m;var n=l.data;if(d(n).hasClass("jim-error-message-table")){c.get(j.id).removeDarkLayer();c.get(j.id).getContentModule().replaceWith(n)}else{m=d(n).attr("id");if(m){m=m.replace("refresh-module-","");c.get(j.id).getContentModule().replaceWith(n);new e.CallbackSupport(j).callback(m)}else{new e.CallbackSupport(j).errorHandler(n)}}},error:function(m,n,l){new e.CallbackSupport(j).errorHandler(l)}};if(a.isConnect()){a.request(g.url,g)}else{g.url=Confluence.getContextPath()+g.url;b.$.ajax(g)}}};e.Refresh=function(h,g){this.id=h;this.wiki=g;this.pageId=arguments.length>2?arguments[2]:null;this.loadingMsg=arguments.length>3?arguments[3]:null};e.CallbackSupport=function(g){this.refresh=g;this.module=d("#refresh-module-"+g.id)};e.CallbackSupport.prototype={errorHandler:function(h){var i=c.get(this.refresh.id);var g="Refresh didn\'t work. Try again or click an issue to see it in JIRA.";i.getErrorMessagePanel().html(g);i.updateRefreshVisibility(e.REFRESH_STATE_FAILED);b.trigger("confluence.extra.jira:jira-table:completed.error",{id:-1,error:h})},callback:function(g){e.replaceRefresh(this.refresh.id,g);b.trigger("confluence.extra.jira:jira-table:completed.success",{id:g||-1})}};var c=function(){if(arguments.length==1){this.id=arguments[0]}};var f=function(){if(arguments.length==1){this.id=arguments[0]}};c.prototype.getRefresh=function(){return new e.Refresh(this.id,this.getWikiMarkup(),this.getPageId(),this.getMacroPanel().html())};f.prototype.getSortable=function(){return new e.Sortable(this.id,d("#refresh-page-id-"+this.id).val(),d("#refresh-"+this.id).html())};c.get=function(h){var g=d("#refresh-"+h);if(!g){return null}return new c(h)};f.get=function(h){var g=d("#refresh-"+h);if(!g){return null}return new f(h)};e.Sortable=function(i,g,h){this.id=i;this.pageId=g;this.loadingMsg=h};f.getAll=function(){return d("div.refresh-macro").map(function(){var g=this.id.replace("refresh-","");return f.get(g)})};c.getAll=function(){return d("div.refresh-macro").map(function(){var g=this.id.replace("refresh-","");return c.get(g)})};c.prototype.getErrorMessagePanel=function(){return d(b.format("#refresh-module-{0} .error-message",this.id))};c.prototype.removeDarkLayer=function(){d("#jim-dark-layout-"+this.id).remove()};c.prototype.displayDarkLayer=function(){var h=d("#refresh-module-"+this.id);var g=h.position();d("<div />",{id:"jim-dark-layout-"+this.id,"class":"jim-sortable-dark-layout"}).appendTo(h)};c.prototype.getMacroPanel=function(){return d("#refresh-"+this.id)};f.prototype.getMacroPanel=function(){return d("#refresh-"+this.id).val()};c.prototype.getContentModule=function(){return d("#refresh-module-"+this.id)};c.prototype.getPageId=function(){return d("#refresh-wiki-"+this.id).data("pageid")};f.prototype.getPageId=function(){return d("#refresh-wiki-"+this.id).data("pageid")};c.prototype.getWikiMarkup=function(){return d(b.format("#refresh-module-{0} .refresh-wiki",this.id)).data("wikimarkup")};c.prototype.getRefreshButton=function(){return d(b.format("#refresh-module-{0} .refresh-issues-button",this.id))};c.prototype.getLoadingButton=function(g){return d(b.format("#refresh-module-{0} .refresh-issues-loading",g||this.id))};f.prototype.getHeadersTable=function(){return d(b.format("#refresh-module-{0} .jira-issues .jira-tablesorter-header",this.id))};c.prototype.getRefreshLink=function(){return d(b.format("#refresh-module-{0} .refresh-issues-link",this.id))};c.prototype.getJiraIssuesArea=function(){return d(b.format("#refresh-module-{0} .jira-issues",this.id))};c.prototype.getIssuesCountArea=function(){return d(b.format("#refresh-module-{0} .total-issues-count",this.id))};c.prototype.updateRefreshVisibility=function(h,g){if(h===e.REFRESH_STATE_STARTED){this.displayDarkLayer();this.getErrorMessagePanel().addClass("hidden");this.getRefreshLink().text("Loading issues");this.getRefreshButton().hide();this.getLoadingButton(g).removeClass("hidden")}else{if(h===e.REFRESH_STATE_FAILED){this.getLoadingButton(g).addClass("hidden");this.removeDarkLayer();this.getRefreshButton().show();this.getRefreshLink().show();this.getErrorMessagePanel().removeClass("hidden");this.getRefreshLink().text("Refresh")}else{if(h===e.REFRESH_STATE_DONE){this.getLoadingButton(g).addClass("hidden");this.removeDarkLayer();this.getRefreshButton().show();this.getRefreshLink().text("Refresh")}}}};return e});
}catch(e){WRMCB(e)};